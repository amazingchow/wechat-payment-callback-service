package service

import (
	"testing"

	"github.com/stretchr/testify/assert"
	wechatpay_utils "github.com/wechatpay-apiv3/wechatpay-go/utils"
)

func TestMakeNewPaymentSignature(t *testing.T) {
	pem := `-----BEGIN PRIVATE KEY-----
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
7wQwszLeJU6zno/56CPjBdp4WwkW/w==
-----END PRIVATE KEY-----	
`
	key, err := wechatpay_utils.LoadPrivateKey(pem)
	assert.Nil(t, err)
	assert.NotNil(t, key)

	signature, err := MakeNewPaymentSignature(key, &SignParams{
		AppId:     "wx8888888888888888",
		Timestamp: 1414561699,
		Nonce:     "5K8264ILTKCH16CQ2502SI8ZNMTM67VS",
		Package:   "prepay_id=wx201410272009395522657a690389285100",
	})
	assert.Nil(t, err)
	assert.Equal(t, "cRhvEAqKgjlenfOuS89U24H3gnN9h0MSpTvDjS8PAWExHkRnsjH/wFEKRjLE2y56pn7z86inss1RbH/HYHX7u1IGwpHlwEhW4osnWFf/h6wLrtSx3pIerPCEpJgZ+qkv+f3VbnZFyw9Ep1yw1Oxu5iZFl58QFJlucfQaW4ACB79Ig09GEypeXZ3F2iC3mZpbMaJZfSyA7opSQukmQln1D2dXJtc+K+au6tUUo/uMCAenXptwgWFdFcvCJXev6RRHKrUg5GfZgOiOFBcurGQEOKy2CFPUqissiSi8w9GNINThxmgV0PzJihh/z8ujg35rHtifx8UUxo3xtVR21q74Ir7Eygu1KTyjCuu6P+AMak49i9uAB+yUxu8J/YC+RJqTbTHqdHEUAs3I9C/XvrcO2EZKLlxXQ8pvdn1wuf/vw5BhBTBio6z/cX2L9usEJbG2OUSO4n8ABRk01BVIc/Qxs7OVwDEUkQFEHVvQX44FLzYL0+/5vZ1rAmDCwzvEbSpV/+CIukGcS0Aw8REPhykZ/AQSvIyWN6TlJtEhLitYNF3jBvITnnUAXx2wuzb81scvjiVJNQg8pwGkHk2hPvEjzGufZOd7o9zWKJJgGeAalJWqfivui1wW2BxLGi1qQpZhT4W1d2l9Ds1T2IbS0gcXSBdYHA8tE2iw/Do2rf0Fp5g=", signature)
}
